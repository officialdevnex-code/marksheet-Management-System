<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marksheet Management System</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 30px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #f39c12;
            margin-top: 20px;
        }
        
        /* Main Styles */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 60px;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .college-logo-header {
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            border: 3px solid #f39c12;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .college-logo-header img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .btn-sm {
            padding: 5px 10px !important;
        }
        
        /* Marksheet Styles */
        .marksheet-container {
            font-family: 'Times New Roman', Times, serif;
            background-color: white;
            padding: 30px;
            border: 2px solid #000;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400"><text x="200" y="200" text-anchor="middle" dominant-baseline="middle" font-family="Arial" font-size="60" fill="rgba(0,0,0,0.05)" transform="rotate(-45,200,200)">SHAH COMMERCE</text></svg>');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 70% auto;
        }
        
        .college-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
        }
        
        .college-logo-top {
            margin: 0 auto 15px;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #2c3e50;
            background-color: white;
            padding: 10px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        
        .college-logo-top img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .college-name {
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .exam-title {
            font-size: 20px;
            color: #666;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .academic-year {
            font-size: 18px;
            color: #666;
        }
        
        .marksheet-details {
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .details-row {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .detail-label {
            width: 200px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .detail-value {
            flex: 1;
            color: #495057;
        }
        
        .marks-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border: 2px solid #000;
        }
        
        .marks-table th {
            border: 1px solid #000;
            padding: 12px 8px;
            text-align: center;
            font-weight: bold;
            background-color: #2c3e50;
            color: white;
            font-size: 16px;
        }
        
        .marks-table td {
            border: 1px solid #000;
            padding: 10px 8px;
            text-align: center;
            font-size: 15px;
        }
        
        .total-row {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        
        .signature-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #000;
        }
        
        .signature-row {
            display: flex;
            justify-content: space-between;
            margin-top: 60px;
        }
        
        .signature-box {
            text-align: center;
            width: 45%;
        }
        
        .signature-line {
            border-top: 1px solid #000;
            width: 80%;
            margin: 0 auto 10px;
            padding-top: 40px;
        }
        
        .signature-name {
            font-weight: bold;
            font-size: 16px;
            margin-top: 5px;
        }
        
        .signature-designation {
            font-size: 14px;
            color: #666;
        }
        
        .note-section {
            margin-top: 40px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .note-section strong {
            color: #e74c3c;
        }
        
        .screenshot-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            font-weight: 600;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            text-align: center;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: white;
            border-left: 5px solid var(--success-color);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        /* Data History Modal */
        .history-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        /* Subject form styles */
        .checkbox-container {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }
        
        .form-check-label {
            color: #dc3545;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #printMarksheet, #printMarksheet * {
                visibility: visible !important;
            }
            
            #printMarksheet {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 30px !important;
                background: white !important;
            }
            
            .no-print, .footer, .screenshot-btn, .header-section, .card, .action-buttons,
            .modal, .toast-container {
                display: none !important;
            }
            
            .marksheet-container {
                border: 2px solid #000 !important;
                box-shadow: none !important;
                margin: 0 auto !important;
                padding: 30px !important;
                max-width: 800px !important;
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org2000/svg" width="400" height="400" viewBox="0 0 400 400"><text x="200" y="200" text-anchor="middle" dominant-baseline="middle" font-family="Arial" font-size="60" fill="rgba(0,0,0,0.05)" transform="rotate(-45,200,200)">SHAH COMMERCE</text></svg>') !important;
                background-repeat: no-repeat !important;
                background-position: center !important;
                background-size: 70% auto !important;
            }
            
            .college-logo-top {
                border: 2px solid #000 !important;
            }
            
            .college-logo-top img {
                display: block !important;
            }
            
            .marks-table th {
                background-color: #2c3e50 !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .college-name {
                font-size: 22px;
            }
            
            .exam-title {
                font-size: 18px;
            }
            
            .college-logo-top {
                width: 90px;
                height: 90px;
                margin-bottom: 10px;
            }
            
            .details-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .detail-label {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .signature-row {
                flex-direction: column;
                gap: 40px;
            }
            
            .signature-box {
                width: 100%;
            }
            
            .screenshot-btn {
                bottom: 80px;
                right: 15px;
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .college-logo-header {
                width: 60px;
                height: 60px;
            }
            
            .btn {
                padding: 8px 16px !important;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-buttons .btn {
                width: 100%;
                max-width: 250px;
            }
            
            .toast-container {
                top: 10px;
                right: 10px;
                left: 10px;
            }
            
            .checkbox-container {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 576px) {
            .college-name {
                font-size: 18px;
            }
            
            .exam-title {
                font-size: 16px;
            }
            
            .college-logo-top {
                width: 70px;
                height: 70px;
            }
            
            .marks-table th,
            .marks-table td {
                padding: 8px 5px;
                font-size: 13px;
            }
            
            .form-check-label {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-name">Marksheet Management System</div>
        <div class="loading-name">Design and Development By Syed Ghina Ul Hassan</div>
        <div class="loading-text">Loading...</div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container"></div>

    <!-- Main Content -->
    <div id="mainContent" style="display: none;">
        <!-- Header with College Logo -->
        <div class="header-section">
            <div class="container">
                <div class="row">
                    <div class="col-12 text-center">
                        <div class="college-logo-header">
                            <img src="./assets/IMG_1188-removebg-preview.png" alt="Shah Commerce College Logo">
                        </div>
                        <h1 class="h3 fw-bold"><i class=""></i> Marksheet Management System</h1>
                        <p class="mb-0">Shah Commerce College</p>
                        <small>Professional Marksheet Generator</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="row">
                <!-- Input Form -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-user-graduate me-2"></i> Student Details
                            </div>
                            <button type="button" class="btn btn-outline-light btn-sm" id="viewHistoryBtn">
                                <i class="fas fa-history me-1"></i> View History
                            </button>
                        </div>
                        <div class="card-body">
                            <form id="marksheetForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Student Name *</label>
                                        <input type="text" class="form-control" id="studentName" value="" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Father's Name *</label>
                                        <input type="text" class="form-control" id="fatherName" value="" required>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Worksheet No *</label>
                                        <input type="text" class="form-control" id="worksheetNo" value="SCC/XI/2024-25/2331" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Program *</label>
                                        <select class="form-select" id="program" required>
                                            <option value="INTERMEDIATE" selected>INTERMEDIATE</option>
                                            <option value="BACHELOR">BACHELOR</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">Class *</label>
                                        <select class="form-select" id="className" required>
                                            <option value="HSC – I (XI)" selected>HSC – I (XI)</option>
                                            <option value="HSC – II (XII)">HSC – II (XII)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Group *</label>
                                        <select class="form-select" id="group" required>
                                            <option value="Commerce" selected>Commerce</option>
                                            <option value="Science">Science</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">Exam Type *</label>
                                        <select class="form-select" id="examType" required>
                                            <option value="MID TERM EXAMINATIONS" selected>MID TERM EXAMINATIONS</option>
                                            <option value="FINAL EXAMINATIONS">FINAL EXAMINATIONS</option>
                                            <option value="ANNUAL EXAMINATIONS">ANNUAL EXAMINATIONS</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Academic Year *</label>
                                        <input type="text" class="form-control" id="academicYear" value="2024-25" required>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <h5 class="mb-3"><i class="fas fa-book me-2"></i> Subject-wise Marks</h5>
                                
                                <div class="table-responsive d-none d-md-block">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th width="30%">Subject Name</th>
                                                <th width="15%">Marks</th>
                                                <th width="15%">Total</th>
                                                <th width="30%">Status</th>
                                                <th width="10%">Actions</th>
                                            </tr>
                                        </thead>
                                    </table>
                                </div>
                                
                                <div id="subjectsContainer">
                                    <!-- Subjects will be added here -->
                                </div>
                                
                                <div class="d-flex justify-content-between mt-4 flex-wrap gap-2">
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-outline-primary" id="addSubjectBtn">
                                            <i class="fas fa-plus me-1"></i> Add Subject
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="clearSubjectsBtn">
                                            <i class="fas fa-trash me-1"></i> Clear All
                                        </button>
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-calculator me-1"></i> Generate Marksheet
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Marksheet Display -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-file-alt me-2"></i> Generated Marksheet
                        </div>
                        <div class="card-body">
                            <div id="marksheetDisplay">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-file-alt fa-4x mb-3"></i>
                                    <h5>Marksheet Preview</h5>
                                    <p>Fill in details and generate marksheet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data History Modal -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Saved Marksheets</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="historyList">
                            <p class="text-center text-muted">Loading history...</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-danger" id="clearHistoryBtn">Clear All History</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Screenshot Button -->
        <button class="btn btn-warning screenshot-btn no-print" id="screenshotBtn">
            <i class="fas fa-camera me-1"></i> Screenshot
        </button>
        
        <!-- Footer -->
        <footer class="footer">
            <div class="container">
                <p class="mb-0">Design By Development <span style="color:#f39c12">Syed Ghina ul Hassan</span></p>
            </div>
        </footer>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Page loaded");
            
            // Hide loading screen after 1 second
            setTimeout(function() {
                document.getElementById('loadingScreen').style.opacity = '0';
                setTimeout(function() {
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    console.log("Main content shown");
                }, 500);
            }, 1000);
            
            // Initialize Bootstrap components
            const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
            
            // Show toast notification
            function showToast(message, type = 'success') {
                const toastContainer = document.querySelector('.toast-container');
                const toastId = 'toast-' + Date.now();
                
                const toastHtml = `
                    <div id="${toastId}" class="toast" role="alert">
                        <div class="toast-header">
                            <strong class="me-auto">${type === 'success' ? 'Success' : 'Info'}</strong>
                            <small>Just now</small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">
                            ${message}
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
                toast.show();
                
                // Remove after hide
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            }
            
            // Save data to localStorage
            function saveMarksheetData(data) {
                try {
                    let savedMarksheets = localStorage.getItem('shahCommerceMarksheets');
                    if (!savedMarksheets) {
                        savedMarksheets = [];
                    } else {
                        savedMarksheets = JSON.parse(savedMarksheets);
                    }
                    
                    // Add timestamp
                    data.timestamp = new Date().toISOString();
                    data.id = 'ms_' + Date.now();
                    
                    // Add to beginning of array
                    savedMarksheets.unshift(data);
                    
                    // Keep only last 50 records
                    if (savedMarksheets.length > 50) {
                        savedMarksheets = savedMarksheets.slice(0, 50);
                    }
                    
                    localStorage.setItem('shahCommerceMarksheets', JSON.stringify(savedMarksheets));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }
            
            // Load saved marksheets
            function loadSavedMarksheets() {
                try {
                    const savedMarksheets = localStorage.getItem('shahCommerceMarksheets');
                    if (!savedMarksheets) return [];
                    return JSON.parse(savedMarksheets);
                } catch (error) {
                    console.error('Error loading data:', error);
                    return [];
                }
            }
            
            // Clear history
            document.getElementById('clearHistoryBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all saved marksheets?')) {
                    localStorage.removeItem('shahCommerceMarksheets');
                    document.getElementById('historyList').innerHTML = `
                        <p class="text-center text-muted">No saved marksheets found.</p>
                    `;
                    showToast('All history cleared successfully', 'info');
                }
            });
            
            // View history button
            document.getElementById('viewHistoryBtn').addEventListener('click', function() {
                const marksheets = loadSavedMarksheets();
                const historyList = document.getElementById('historyList');
                
                if (marksheets.length === 0) {
                    historyList.innerHTML = `
                        <p class="text-center text-muted">No saved marksheets found.</p>
                    `;
                } else {
                    let historyHtml = '<div class="list-group">';
                    
                    marksheets.forEach((marksheet, index) => {
                        const date = new Date(marksheet.timestamp).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        historyHtml += `
                            <div class="list-group-item history-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">${marksheet.studentName}</h6>
                                        <small class="text-muted">${marksheet.fatherName} | ${marksheet.className} | ${marksheet.examType}</small>
                                        <div class="mt-1">
                                            <small>Worksheet: ${marksheet.worksheetNo} | Total Marks: ${marksheet.totalMarks}/${marksheet.maxMarks}</small>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted d-block">${date}</small>
                                        <button class="btn btn-sm btn-outline-primary mt-1 load-marksheet-btn" data-id="${marksheet.id}">
                                            Load
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    historyHtml += '</div>';
                    historyList.innerHTML = historyHtml;
                    
                    // Add event listeners to load buttons
                    document.querySelectorAll('.load-marksheet-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const marksheets = loadSavedMarksheets();
                            const marksheet = marksheets.find(m => m.id === id);
                            
                            if (marksheet) {
                                // Load data into form
                                document.getElementById('studentName').value = marksheet.studentName;
                                document.getElementById('fatherName').value = marksheet.fatherName;
                                document.getElementById('worksheetNo').value = marksheet.worksheetNo;
                                document.getElementById('program').value = marksheet.program;
                                document.getElementById('className').value = marksheet.className;
                                document.getElementById('group').value = marksheet.group;
                                document.getElementById('examType').value = marksheet.examType;
                                document.getElementById('academicYear').value = marksheet.academicYear;
                                
                                // Load subjects
                                loadSubjectsFromData(marksheet.subjects);
                                
                                // Close modal
                                historyModal.hide();
                                
                                // Generate marksheet
                                setTimeout(() => {
                                    document.getElementById('marksheetForm').dispatchEvent(new Event('submit'));
                                }, 100);
                                
                                showToast('Marksheet loaded successfully');
                            }
                        });
                    });
                }
                
                historyModal.show();
            });
            
            // Default subjects
            const defaultSubjects = [
                { name: "Islamiat", marks: 42, total: 50 },
                { name: "Urdu", marks: 87, total: 100 },
                { name: "English", marks: 78, total: 100 },
                { name: "Principal of Commerce", marks: 64, total: 75 },
                { name: "Business Mathematics", marks: 48, total: 50 },
                { name: "Economics", marks: 66, total: 75 },
                { name: "Principles of Accounting - I", marks: 97, total: 100 }
            ];
            
            // Load default subjects
            function loadDefaultSubjects() {
                console.log("Loading default subjects");
                const container = document.getElementById('subjectsContainer');
                container.innerHTML = '';
                
                defaultSubjects.forEach((subject, index) => {
                    addSubjectRow(subject.name, subject.marks, subject.total);
                });
            }
            
            // Load subjects from saved data
            function loadSubjectsFromData(subjectsData) {
                const container = document.getElementById('subjectsContainer');
                container.innerHTML = '';
                
                subjectsData.forEach((subject, index) => {
                    addSubjectRow(subject.name, subject.marks, subject.total);
                    
                    // Last added row ko dhundh ke absent/fail status set karein
                    setTimeout(() => {
                        const lastRow = container.lastElementChild;
                        if (lastRow) {
                            if (subject.absent) {
                                lastRow.querySelector('.absent-checkbox').checked = true;
                            }
                            if (subject.fail) {
                                lastRow.querySelector('.fail-checkbox').checked = true;
                            }
                        }
                    }, 10);
                });
            }
            
            // Add subject row WITH absent and fail options
            function addSubjectRow(name = '', marks = '', total = 100) {
                const container = document.getElementById('subjectsContainer');
                const rowId = 'subject_' + Date.now();
                
                const row = document.createElement('div');
                row.className = 'subject-row mb-3';
                row.setAttribute('data-id', rowId);
                row.innerHTML = `
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3 col-12">
                            <input type="text" class="form-control subject-name" placeholder="Subject Name" value="${name}" required>
                        </div>
                        <div class="col-md-2 col-6">
                            <input type="number" class="form-control subject-marks" placeholder="Marks" value="${marks}" min="0" required>
                        </div>
                        <div class="col-md-2 col-6">
                            <input type="number" class="form-control subject-total" placeholder="Total" value="${total}" min="1" required>
                        </div>
                        <div class="col-md-3 col-12">
                            <div class="checkbox-container">
                                <div class="form-check">
                                    <input class="form-check-input absent-checkbox" type="checkbox" id="absent_${rowId}">
                                    <label class="form-check-label" for="absent_${rowId}">
                                        Absent
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input fail-checkbox" type="checkbox" id="fail_${rowId}">
                                    <label class="form-check-label" for="fail_${rowId}">
                                        Fail
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 col-12">
                            <div class="d-flex justify-content-center">
                                <button type="button" class="btn btn-danger btn-sm remove-subject w-100">
                                    <i class="fas fa-times"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(row);
                
                // Remove button event
                row.querySelector('.remove-subject').addEventListener('click', function() {
                    if (container.children.length > 1) {
                        row.remove();
                    }
                });
                
                // Absent/Fail checkbox event - disable marks if checked
                row.querySelector('.absent-checkbox').addEventListener('change', function() {
                    const marksInput = row.querySelector('.subject-marks');
                    if (this.checked) {
                        marksInput.value = 0;
                        marksInput.disabled = true;
                        marksInput.style.backgroundColor = '#f8d7da';
                    } else {
                        marksInput.disabled = false;
                        marksInput.style.backgroundColor = '';
                    }
                });
                
                row.querySelector('.fail-checkbox').addEventListener('change', function() {
                    const marksInput = row.querySelector('.subject-marks');
                    if (this.checked) {
                        marksInput.value = 0;
                        marksInput.disabled = true;
                        marksInput.style.backgroundColor = '#f8d7da';
                    } else {
                        marksInput.disabled = false;
                        marksInput.style.backgroundColor = '';
                    }
                });
                
                console.log("Subject row added with absent/fail options");
            }
            
            // Add subject button
            document.getElementById('addSubjectBtn').addEventListener('click', function() {
                console.log("Add subject clicked");
                addSubjectRow();
            });
            
            // Clear all subjects button
            document.getElementById('clearSubjectsBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all subjects?')) {
                    const container = document.getElementById('subjectsContainer');
                    container.innerHTML = '';
                    addSubjectRow(); // Add one empty row
                }
            });
            
            // Form submit - Generate Marksheet
            document.getElementById('marksheetForm').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log("Form submitted");
                
                // Get form values
                const studentName = document.getElementById('studentName').value.trim();
                const fatherName = document.getElementById('fatherName').value.trim();
                const worksheetNo = document.getElementById('worksheetNo').value.trim();
                const program = document.getElementById('program').value;
                const className = document.getElementById('className').value;
                const group = document.getElementById('group').value;
                const examType = document.getElementById('examType').value;
                const academicYear = document.getElementById('academicYear').value.trim();
                
                // Validate required fields
                if (!studentName || !fatherName || !worksheetNo) {
                    alert('Please fill in all required fields!');
                    return;
                }
                
                // Get subjects data
                const subjects = [];
                let totalMarks = 0;
                let maxMarks = 0;
                let hasError = false;
                let isAbsent = false;
                let isFail = false;
                let failOrAbsentSubjects = [];

                document.querySelectorAll('.subject-row').forEach((row, index) => {
                    const name = row.querySelector('.subject-name').value.trim();
                    const marks = parseInt(row.querySelector('.subject-marks').value) || 0;
                    const total = parseInt(row.querySelector('.subject-total').value) || 100;
                    const absentChecked = row.querySelector('.absent-checkbox').checked;
                    const failChecked = row.querySelector('.fail-checkbox').checked;
                    
                    if (!name) {
                        alert(`Please enter subject name for row ${index + 1}`);
                        hasError = true;
                        return;
                    }
                    
                    if (isNaN(marks) || marks < 0) {
                        alert(`Invalid marks for ${name}`);
                        hasError = true;
                        return;
                    }
                    
                    if (isNaN(total) || total <= 0) {
                        alert(`Invalid total marks for ${name}`);
                        hasError = true;
                        return;
                    }
                    
                    if (marks > total && !absentChecked && !failChecked) {
                        alert(`Marks cannot be greater than total for ${name}`);
                        hasError = true;
                        return;
                    }
                    
                    // Set absent or fail status
                    if (absentChecked) {
                        isAbsent = true;
                        failOrAbsentSubjects.push(`${name} (Absent)`);
                    }
                    if (failChecked) {
                        isFail = true;
                        failOrAbsentSubjects.push(`${name} (Fail)`);
                    }
                    
                    // If absent or fail, marks should be 0
                    const finalMarks = (absentChecked || failChecked) ? 0 : marks;
                    
                    subjects.push({ 
                        name, 
                        marks: finalMarks, 
                        total: total,
                        percentage: total > 0 ? ((finalMarks / total) * 100).toFixed(2) : "0.00",
                        absent: absentChecked,
                        fail: failChecked
                    });
                    
                    totalMarks += finalMarks;
                    maxMarks += total;
                });

                if (hasError) return;

                if (subjects.length === 0) {
                    alert('Please add at least one subject!');
                    return;
                }

                // Calculate overall percentage
                const overallPercentage = maxMarks > 0 ? ((totalMarks / maxMarks) * 100).toFixed(2) : 0;

                // Determine result status - YAHAN UPDATE KAR DIYA HAI
                // Agar kisi bhi subject mein absent ya fail hai, toh overall result FAIL
                let resultStatus;
                let resultColor;
                let resultReason = "";
                
                if (isAbsent || isFail) {
                    resultStatus = 'FAIL';
                    resultColor = 'red';
                    resultReason = ` (${failOrAbsentSubjects.join(', ')})`;
                } else if (overallPercentage >= 50) {
                    resultStatus = 'PASS';
                    resultColor = 'green';
                } else {
                    resultStatus = 'FAIL';
                    resultColor = 'red';
                    resultReason = ` (Overall Percentage: ${overallPercentage}% < 50%)`;
                }
                
                // Number to words function
                function numberToWords(num) {
                    if (num === 0) return 'Zero';
                    const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 
                                'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 
                                'Eighteen', 'Nineteen'];
                    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
                    
                    if (num < 20) return ones[num];
                    if (num < 100) {
                        return tens[Math.floor(num/10)] + (num%10 ? ' ' + ones[num%10] : '');
                    }
                    if (num < 1000) {
                        return ones[Math.floor(num/100)] + ' Hundred' + (num%100 ? ' and ' + numberToWords(num%100) : '');
                    }
                    return num.toString();
                }
                
                // Generate marksheet HTML
                const marksheetHTML = `
                    <div class="marksheet-container" id="printMarksheet">
                        <div class="college-header">
                            <div class="college-logo-top">
                                <img src="./assets/IMG_1188-removebg-preview.png" alt="Shah Commerce College Logo">
                            </div>
                            <h1 class="college-name">SHAH COMMERCE COLLEGE</h1>
                            <div class="exam-title">STATEMENT OF MARKS – ${examType}</div>
                            <div class="academic-year">ACADEMIC YEAR: ${academicYear}</div>
                        </div>
                        
                        <div style="text-align: right; font-weight: bold; margin-bottom: 20px; font-size: 16px;">
                            Marksheet No: MS/${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}${String(new Date().getDate()).padStart(2,'0')}/001
                        </div>
                        
                        <div class="marksheet-details">
                            <div class="details-row">
                                <div class="detail-label">Worksheet No:</div>
                                <div class="detail-value">${worksheetNo}</div>
                            </div>
                            <div class="details-row">
                                <div class="detail-label">Program:</div>
                                <div class="detail-value">${program}</div>
                            </div>
                            <div class="details-row">
                                <div class="detail-label">Class:</div>
                                <div class="detail-value">${className}</div>
                            </div>
                            <div class="details-row">
                                <div class="detail-label">Group:</div>
                                <div class="detail-value">${group}</div>
                            </div>
                            <div class="details-row">
                                <div class="detail-label">Name of Candidate:</div>
                                <div class="detail-value"><strong>${studentName}</strong></div>
                            </div>
                            <div class="details-row">
                                <div class="detail-label">Father's Name:</div>
                                <div class="detail-value"><strong>${fatherName}</strong></div>
                            </div>
                        </div>
                        
                        <table class="marks-table">
                            <thead>
                                <tr>
                                    <th width="8%">Sr. No</th>
                                    <th width="42%">Subject Name</th>
                                    <th width="15%">Marks Obtained</th>
                                    <th width="15%">Total Marks</th>
                                    <th width="20%">Remarks</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${subjects.map((subject, index) => {
                                    let remarks = `${subject.percentage}%`;
                                    if (subject.absent) {
                                        remarks = '<span style="color: red; font-weight: bold;">ABSENT</span>';
                                    } else if (subject.fail) {
                                        remarks = '<span style="color: red; font-weight: bold;">FAIL</span>';
                                    }
                                    
                                    return `
                                        <tr>
                                            <td>${index + 1}</td>
                                            <td style="text-align: left; padding-left: 15px;">${subject.name}</td>
                                            <td>${subject.absent || subject.fail ? '0' : subject.marks}</td>
                                            <td>${subject.total}</td>
                                            <td>${remarks}</td>
                                        </tr>
                                    `;
                                }).join('')}
                                
                                <tr class="total-row">
                                    <td colspan="2"><strong>TOTAL MARKS</strong></td>
                                    <td><strong>${totalMarks}</strong></td>
                                    <td><strong>${maxMarks}</strong></td>
                                    <td><strong>${overallPercentage}%</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="5" style="text-align: left; padding-left: 15px; font-style: italic;">
                                        <strong>In Words:</strong> ${numberToWords(totalMarks)} out of ${numberToWords(maxMarks)} 
                                        | <strong>Result Status:</strong> <span style="color: ${resultColor}; font-weight: bold;">
                                        ${resultStatus}${resultReason}</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="signature-section">
                            <div class="signature-row" style="margin-top: 40px;">
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <div class="signature-name">Approved By</div>
                                    <div class="signature-designation">Principal</div>
                                </div>
                                
                                <div class="signature-box">
                                    <div class="signature-line"></div>
                                    <div class="signature-name">Controller of Examinations</div>
                                    <div class="signature-designation">Shah Commerce College</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="note-section">
                            <div><strong>IMPORTANT NOTES:</strong></div>
                            <ol style="margin-top: 10px; margin-bottom: 10px; padding-left: 20px;">
                                <li>This is an official document issued by Shah Commerce College.</li>
                                <li>If student is absent or fails in any subject, final result will be FAIL.</li>
                                <li>Result is declared based on total percentage obtained and subject-wise performance.</li>
                            </ol>
                            <div style="text-align: center; margin-top: 15px; font-style: italic;">
                                <strong>Office Seal & Signature</strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons no-print">
                        <button type="button" class="btn btn-primary" onclick="printMarksheet()">
                            <i class="fas fa-print me-1"></i> Print Marksheet
                        </button>
                        <button type="button" class="btn btn-warning" onclick="takeScreenshot()">
                            <i class="fas fa-camera me-1"></i> Take Screenshot
                        </button>
                        <button type="button" class="btn btn-info" onclick="saveCurrentMarksheet()">
                            <i class="fas fa-save me-1"></i> Save Marksheet
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo me-1"></i> Reset Form
                        </button>
                    </div>
                `;
                
                // Display marksheet
                document.getElementById('marksheetDisplay').innerHTML = marksheetHTML;
                
                // Save marksheet data
                const marksheetData = {
                    studentName,
                    fatherName,
                    worksheetNo,
                    program,
                    className,
                    group,
                    examType,
                    academicYear,
                    subjects,
                    totalMarks,
                    maxMarks,
                    overallPercentage,
                    resultStatus: resultStatus,
                    failOrAbsentSubjects: failOrAbsentSubjects
                };
                
                // Auto-save to localStorage
                if (saveMarksheetData(marksheetData)) {
                    console.log("Marksheet data saved successfully");
                }
                
                // Show success message
                showToast('Marksheet generated successfully!');
                console.log("Marksheet generated with absent/fail logic");
            });
            
            // Save current marksheet function
            window.saveCurrentMarksheet = function() {
                const marksheetElement = document.getElementById('printMarksheet');
                
                if (!marksheetElement) {
                    alert('Please generate a marksheet first!');
                    return;
                }
                
                showToast('Marksheet already saved automatically!');
            };
            
            // Print function
            window.printMarksheet = function() {
                console.log("Print function called");
                const marksheetElement = document.getElementById('printMarksheet');
                
                if (!marksheetElement) {
                    alert('Please generate a marksheet first!');
                    return;
                }
                
                // Open print dialog
                window.print();
            };
            
            // Screenshot function
            window.takeScreenshot = function() {
                console.log("Screenshot function called");
                const marksheetElement = document.getElementById('printMarksheet');
                
                if (!marksheetElement) {
                    alert('Please generate a marksheet first!');
                    return;
                }
                
                // Show loading
                const screenshotBtn = document.getElementById('screenshotBtn');
                const originalText = screenshotBtn.innerHTML;
                screenshotBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Capturing...';
                screenshotBtn.disabled = true;
                
                // Capture screenshot
                html2canvas(marksheetElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    // Create download link
                    const link = document.createElement('a');
                    const studentName = document.getElementById('studentName').value.replace(/\s+/g, '_') || 'marksheet';
                    const fileName = `Shah_Commerce_Marksheet_${studentName}_${Date.now()}.png`;
                    
                    link.download = fileName;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Restore button
                    screenshotBtn.innerHTML = originalText;
                    screenshotBtn.disabled = false;
                    
                    // Show success
                    showToast('Screenshot saved successfully!');
                    console.log("Screenshot captured");
                    
                }).catch(error => {
                    console.error('Screenshot error:', error);
                    alert('Failed to capture screenshot. Please try again.');
                    screenshotBtn.innerHTML = originalText;
                    screenshotBtn.disabled = false;
                });
            };
            
            // Reset form function
            window.resetForm = function() {
                if (confirm('Are you sure you want to reset all data?')) {
                    document.getElementById('marksheetForm').reset();
                    document.getElementById('marksheetDisplay').innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-file-alt fa-4x mb-3"></i>
                            <h5>Marksheet Preview</h5>
                            <p>Fill in details and generate marksheet</p>
                        </div>
                    `;
                    loadDefaultSubjects();
                    showToast('Form reset successfully', 'info');
                    console.log("Form reset");
                }
            };
            
            // Initialize
            loadDefaultSubjects();
            
            // Initialize screenshot button
            document.getElementById('screenshotBtn').addEventListener('click', takeScreenshot);
            
            console.log("All functions initialized with fail/absent logic");
        });
    </script>
</body>
</html>
